global
    log stdout format raw local0
    maxconn 4096
    stats socket /var/run/haproxy.sock mode 600 level admin
    stats timeout 2m

resolvers docker
    nameserver dns1 127.0.0.11:53
    nameserver dns2 172.30.0.1:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold other 30s
    hold refused 30s
    hold nx 30s
    hold timeout 30s
    hold valid 10s
    hold obsolete 30s

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  redispatch
    retries 3
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    timeout check   10000ms

# HAProxy Statistics Dashboard
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-node

# Frontend - Entry point for application
frontend http_front
    bind *:80
    default_backend app_backend

# Backend - Application instances
backend app_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    # Health check configuration
    default-server inter 2s fall 3 rise 2 check

    server app1 app1:5000 check resolvers docker init-addr libc,none
    server app2 app2:5000 check resolvers docker init-addr libc,none

# PostgreSQL Write Frontend (Primary only)
frontend postgres_write
    bind *:6432
    mode tcp
    option tcplog
    default_backend postgres_primary

# PostgreSQL Read Frontend (Both nodes)
frontend postgres_read
    bind *:6433
    mode tcp
    option tcplog
    default_backend postgres_replicas

# Backend - PostgreSQL Primary (Write)
backend postgres_primary
    mode tcp
    option pgsql-check user haproxy_check

    # Health check configuration
    default-server inter 3s fall 3 rise 2 check

    server pg1 postgres-primary:5432 check resolvers docker init-addr libc,none
    server pg2 postgres-replica1:5432 check backup resolvers docker init-addr libc,none

# Backend - PostgreSQL Replicas (Read)
backend postgres_replicas
    mode tcp
    balance roundrobin
    option pgsql-check user haproxy_check

    # Health check configuration
    default-server inter 3s fall 3 rise 2 check

    server pg1 postgres-primary:5432 check resolvers docker init-addr libc,none
    server pg2 postgres-replica1:5432 check resolvers docker init-addr libc,none
